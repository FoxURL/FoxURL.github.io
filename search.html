<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Search</title>
<style>
  :root {
    --accent: #ff7a00;
    --bg: #fff7f0;
    --panel: white;
    --text: #333;
  }
  body.dark {
    --accent: #ffa64d;
    --bg: #1a1a1a;
    --panel: #2b2b2b;
    --text: #f3f3f3;
  }

  body {
    font-family: Arial, sans-serif;
    background: var(--bg);
    margin: 0;
    padding: 20px;
    color: var(--text);
    transition: 0.2s background, 0.2s color;
  }
  h1 {
    color: var(--accent);
    text-align: center;
    margin-bottom: 20px;
  }

  #topBar {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-bottom: 15px;
  }
  #darkToggle, #voiceBtn {
    padding: 8px 15px;
    border-radius: 8px;
    background: var(--accent);
    color: white;
    cursor: pointer;
    border: none;
  }

  #searchContainer {
    position: relative;
    max-width: 650px;
    margin: 0 auto;
    animation: fadeIn 0.5s ease;
  }
  #searchBox {
    width: 100%;
    padding: 15px;
    font-size: 18px;
    border: 2px solid var(--accent);
    border-radius: 10px;
    outline: none;
    background: var(--panel);
    color: var(--text);
  }

  /* Suggestions box */
  #suggestions {
    position: absolute;
    top: 56px;
    width: 100%;
    background: var(--panel);
    border: 2px solid var(--accent);
    border-top: none;
    border-bottom-left-radius: 10px;
    border-bottom-right-radius: 10px;
    max-height: 230px;
    overflow-y: auto;
    display: none;
    animation: fadeIn 0.18s ease;
    z-index: 20;
  }
  .suggestion {
    padding: 12px;
    border-bottom: 1px solid rgba(0,0,0,0.07);
    cursor: pointer;
  }
  .suggestion:hover,
  .suggestion.active {
    background: rgba(255,122,0,0.15);
  }

  /* Preview Panel */
  #preview {
    max-width: 650px;
    margin: 20px auto;
    background: var(--panel);
    padding: 20px;
    border-left: 4px solid var(--accent);
    border-radius: 10px;
    display: none;
    animation: fadeIn 0.25s ease;
  }

  /* Results */
  .result {
    background: var(--panel);
    margin-top: 15px;
    padding: 15px;
    border-left: 4px solid var(--accent);
    border-radius: 8px;
    transition: 0.2s;
    animation: fadeIn 0.25s ease;
  }
  .result:hover {
    background: rgba(255,122,0,0.12);
    cursor: pointer;
  }
  .name {
    font-size: 20px;
    color: var(--accent);
    margin-bottom: 8px;
  }

  .tags {
    margin-top: 8px;
  }
  .tag {
    display: inline-block;
    background: var(--accent);
    color: white;
    padding: 4px 8px;
    font-size: 12px;
    border-radius: 6px;
    margin-right: 6px;
  }

  #extras {
    max-width: 650px;
    margin: 20px auto;
  }
  .extraPanel {
    padding: 15px;
    background: var(--panel);
    border-radius: 10px;
    margin-top: 10px;
    animation: fadeIn 0.3s ease;
  }

  .highlight {
    background: yellow;
    color: black;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(6px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>
</head>
<body>

<h1>Search</h1>

<div id="topBar">
  <button id="darkToggle">ðŸŒ™ Dark Mode</button>
  <button id="voiceBtn">ðŸŽ¤ Voice</button>
</div>

<div id="searchContainer">
  <input type="text" id="searchBox" placeholder="Search pages... (Ctrl + K)">
  <div id="suggestions"></div>
</div>

<div id="preview"></div>
<div id="results"></div>

<div id="extras"></div>

<script>
/////////////////////////////////////////////////////////////////////
// LOAD DATA
/////////////////////////////////////////////////////////////////////

async function loadPages() {
  const response = await fetch("layout.json");
  const data = await response.json();
  return data.pages;
}

/////////////////////////////////////////////////////////////////////
// FUZZY SEARCH (basic Levenshtein)
/////////////////////////////////////////////////////////////////////

function levenshtein(a, b) {
  if (!a || !b) return Infinity;
  const dp = Array(b.length + 1).fill(null).map(() =>
    Array(a.length + 1).fill(null)
  );
  for (let i = 0; i <= a.length; i++) dp[0][i] = i;
  for (let j = 0; j <= b.length; j++) dp[j][0] = j;

  for (let j = 1; j <= b.length; j++) {
    for (let i = 1; i <= a.length; i++) {
      const cost = a[i-1] === b[j-1] ? 0 : 1;
      dp[j][i] = Math.min(
        dp[j][i-1] + 1,
        dp[j-1][i] + 1,
        dp[j-1][i-1] + cost
      );
    }
  }
  return dp[b.length][a.length];
}

/////////////////////////////////////////////////////////////////////
// SEARCH RANKING + MATCHING SYSTEM
/////////////////////////////////////////////////////////////////////

function scoreItem(item, q) {
  q = q.toLowerCase();
  let score = 0;

  // Strong weights
  if (item.name.toLowerCase().includes(q)) score += 50;
  if (item.description.toLowerCase().includes(q)) score += 20;

  // Tag match
  if (item.tags) item.tags.forEach(t => {
    if (t.toLowerCase().includes(q)) score += 30;
  });

  // Fuzzy matching bonus
  const dist = levenshtein(item.name.toLowerCase(), q);
  score += Math.max(0, 20 - dist);

  return score;
}

function fuzzyFilter(pages, query) {
  if (!query) return [];
  const scored = pages.map(p => ({
    ...p,
    _score: scoreItem(p, query)
  }));
  return scored
    .filter(p => p._score > 10) // relevance threshold
    .sort((a,b) => b._score - a._score);
}

/////////////////////////////////////////////////////////////////////
// VISUAL HELPERS
/////////////////////////////////////////////////////////////////////

function highlight(text, q) {
  if (!q) return text;
  const regex = new RegExp(q, "ig");
  return text.replace(regex, match => `<span class="highlight">${match}</span>`);
}

function showPreview(item) {
  const box = document.getElementById("preview");
  box.style.display = "block";
  box.innerHTML = `
    <h2 style="color: var(--accent); margin-top: 0;">${item.name}</h2>
    <p>${item.description}</p>
    ${(item.tags ? item.tags.map(t => `<span class="tag">${t}</span>`).join("") : "")}
    <br><br>
    <a href="${item.link}" style="color: var(--accent); font-weight: bold;">Open Page â†’</a>
  `;
}

/////////////////////////////////////////////////////////////////////
// RENDERING
/////////////////////////////////////////////////////////////////////

function renderSuggestions(results) {
  const box = document.getElementById("suggestions");
  box.innerHTML = "";
  if (results.length === 0) { box.style.display = "none"; return; }

  results.slice(0, 8).forEach((r, i) => {
    const div = document.createElement("div");
    div.className = "suggestion";
    div.dataset.index = i;
    div.textContent = r.name;

    div.onmouseover = () => showPreview(r);
    div.onclick = () => window.location.href = r.link;
    box.appendChild(div);
  });

  box.style.display = "block";
}

function renderResults(results, q) {
  const container = document.getElementById("results");
  container.innerHTML = "";

  results.forEach(r => {
    const el = document.createElement("a");
    el.href = r.link;

    let tagsHTML = "";
    if (r.tags) tagsHTML = `<div class="tags">${r.tags.map(t => `<span class="tag">${t}</span>`).join("")}</div>`;

    el.innerHTML = `
      <div class="result">
        <div class="name">${highlight(r.name, q)}</div>
        <div class="desc">${highlight(r.description, q)}</div>
        ${tagsHTML}
      </div>
    `;
    container.appendChild(el);
  });
}

/////////////////////////////////////////////////////////////////////
// HISTORY + TRENDING
/////////////////////////////////////////////////////////////////////

function addToHistory(q) {
  if (!q.trim()) return;
  let h = JSON.parse(localStorage.getItem("searchHistory") || "[]");
  if (!h.includes(q)) {
    h.unshift(q);
    if (h.length > 10) h.pop();
  }
  localStorage.setItem("searchHistory", JSON.stringify(h));
}

function renderExtras() {
  const h = JSON.parse(localStorage.getItem("searchHistory") || "[]");
  const box = document.getElementById("extras");
  box.innerHTML = "";

  if (h.length > 0) {
    box.innerHTML += `
      <div class="extraPanel">
        <h3 style="margin-top:0; color:var(--accent);">Search History</h3>
        ${h.map(x => `<span class="tag">${x}</span>`).join(" ")}
      </div>
    `;
  }
}

/////////////////////////////////////////////////////////////////////
// VOICE SEARCH
/////////////////////////////////////////////////////////////////////

function startVoice() {
  const rec = new webkitSpeechRecognition();
  rec.lang = "en-US";
  rec.start();
  rec.onresult = e => {
    document.getElementById("searchBox").value = e.results[0][0].transcript;
    triggerSearch();
  };
}

/////////////////////////////////////////////////////////////////////
// MAIN LOGIC
/////////////////////////////////////////////////////////////////////

let allPages = [];
let suggestionIndex = -1;

function triggerSearch() {
  const q = document.getElementById("searchBox").value;
  const filtered = fuzzyFilter(allPages, q);

  suggestionIndex = -1;
  renderSuggestions(filtered);
  renderResults(filtered, q);

  if (filtered[0]) showPreview(filtered[0]);
}

window.onload = async () => {
  allPages = await loadPages();

  const searchBox = document.getElementById("searchBox");

  searchBox.addEventListener("input", () => {
    triggerSearch();
  });

  searchBox.addEventListener("keydown", (e) => {
    const items = [...document.querySelectorAll(".suggestion")];
    if (items.length === 0) return;

    if (e.key === "ArrowDown") {
      suggestionIndex = (suggestionIndex + 1) % items.length;
      updateActive(items);
      e.preventDefault();
    }
    if (e.key === "ArrowUp") {
      suggestionIndex = (suggestionIndex - 1 + items.length) % items.length;
      updateActive(items);
      e.preventDefault();
    }
    if (e.key === "Enter" && suggestionIndex >= 0) {
      items[suggestionIndex].click();
    }
  });

  function updateActive(items) {
    items.forEach(i => i.classList.remove("active"));
    if (items[suggestionIndex]) {
      items[suggestionIndex].classList.add("active");
      items[suggestionIndex].scrollIntoView({ block: "nearest" });
    }
  }

  // DARK MODE
  document.getElementById("darkToggle").onclick = () => {
    document.body.classList.toggle("dark");
  };

  // VOICE SEARCH
  document.getElementById("voiceBtn").onclick = startVoice;

  // GLOBAL SHORTCUT (Ctrl + K)
  document.addEventListener("keydown", (e) => {
    if (e.ctrlKey && e.key.toLowerCase() === "k") {
      e.preventDefault();
      searchBox.focus();
    }
  });

  renderExtras();
};
</script>

</body>
</html>
